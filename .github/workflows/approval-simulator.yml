name: Validar Criterios de Revisor por Checkboxes

on:
  pull_request:
    types: [opened, reopened, synchronize, edited] # 'edited' es clave para cuando el revisor marca las casillas

jobs:
  check_revisor_criterias:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: Extraer y validar checkboxes del revisor
        id: validate_checkboxes
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          echo "Obteniendo descripciÃ³n de PR #$PR_NUMBER..."

          # Obtener el cuerpo (descripciÃ³n) de la PR usando la GitHub CLI
          PR_BODY=$(gh pr view $PR_NUMBER --json body --jq '.body')
          
          echo "--- Contenido de la descripciÃ³n de la PR ---"
          echo "$PR_BODY"
          echo "------------------------------------------"

          # ExtracciÃ³n de la secciÃ³n de "Criterios de AprobaciÃ³n de Entendimiento"
          # Es crucial para solo validar los checkboxes relevantes para el revisor.
          # Este 'awk' buscarÃ¡ la secciÃ³n entre el tÃ­tulo '## ðŸš¦ Criterios de AprobaciÃ³n de Entendimiento' y la siguiente '---'.
          # Si la secciÃ³n no existe, awk devolverÃ¡ vacÃ­o. El '|| true' evita que awk falle si no encuentra la secciÃ³n.
          REVISOR_CHECKBOXES_SECTION=$(echo "$PR_BODY" | awk '/## ðŸš¦ Criterios de AprobaciÃ³n de Entendimiento/,/---/ {
              if ($0 ~ /^## ðŸš¦ Criterios de AprobaciÃ³n de Entendimiento/) { in_section = 1; next }
              if ($0 ~ /^---/) { in_section = 0 }
              if (in_section) { print }
          }' || true)

          if [ -z "$REVISOR_CHECKBOXES_SECTION" ]; then
            echo "::error::ðŸš¨ No se encontrÃ³ la secciÃ³n 'Criterios de AprobaciÃ³n de Entendimiento' en la descripciÃ³n de la PR. AsegÃºrate de usar la plantilla correcta."
            exit 1
          fi

          echo "--- SecciÃ³n de checkboxes del revisor ---"
          echo "$REVISOR_CHECKBOXES_SECTION"
          echo "---------------------------------------"

          # Contar checkboxes sin marcar en la secciÃ³n del revisor
          # Esto busca lÃ­neas que empiecen con '- [' y contengan un espacio en blanco entre los corchetes.
          UNMARKED_REVISOR_CHECKBOXES=$(echo "$REVISOR_CHECKBOXES_SECTION" | grep -oP '^- \[\s*\s*\].*' | wc -l)

          echo "NÃºmero de checkboxes del revisor sin marcar: $UNMARKED_REVISOR_CHECKBOXES"

          if [ "$UNMARKED_REVISOR_CHECKBOXES" -gt 0 ]; then
            echo "::error::ðŸš¨ El revisor AÃšN NO ha marcado todos los 'Criterios de AprobaciÃ³n de Entendimiento'. Por favor, Revisor, edita esta PR y marca los checkboxes necesarios."
            echo "status=pending_revisor_approval" >> $GITHUB_OUTPUT
            exit 1 # Esto harÃ¡ que el job falle y bloquee la fusiÃ³n.
          else
            echo "::notice::âœ… Â¡Todos los criterios de aprobaciÃ³n del revisor han sido marcados! La PR puede fusionarse."
            echo "status=approved_by_revisor" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }} # Permite al Action usar la GitHub CLI para leer la PR.

      - name: Mensaje de guÃ­a para el revisor (solo si la aprobaciÃ³n estÃ¡ pendiente)
        if: steps.validate_checkboxes.outputs.status == 'pending_revisor_approval'
        run: |
          echo "### âš ï¸ Requiere AprobaciÃ³n de Entendimiento del Revisor âš ï¸" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "Estimado revisor, para que esta Pull Request pueda fusionarse, es necesario que **edites la descripciÃ³n de la PR y marques todos los *checkboxes*** en la secciÃ³n 'Criterios de AprobaciÃ³n de Entendimiento'." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Una vez marcados, guarda la descripciÃ³n y este check se actualizarÃ¡ automÃ¡ticamente." >> $GITHUB_STEP_SUMMARY